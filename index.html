<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>NIVA - Geoplaced AR</title>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.0.0/aframe/build/aframe-ar-nft.js"></script>
    <script src='arjs-look-controls.js'></script>
    <script src='arjs-webcam-texture.js'></script>
    <script>
        window.onload = () => 
        {
            const button = document.querySelector('button[data-action="change"]');
            button.innerText = '?';
            button.addEventListener('click', acquireDistance);

            let places = staticLoadPlaces();
            renderPlaces(places);
        };

        function staticLoadPlaces() 
        {
            return [
            {
                name: 'Location 1',
                location: 
                {
                    // decomment the following and add coordinates:
                    lat: 52.2667465209961,
                    lng: -7.09122848510742,
                },
            },];
        } // End of staticLoadPlaces function

        var models = [
            {
                url: './Marker_Red.gltf',
                scale: '0.5 0.5 0.5',
                info: 'Outside of range',
                rotation: '0 180 0',
            },
            {
                url: './Marker_Green.gltf',
                scale: '0.5 0.5 0.5',
                rotation: '0 180 0',
                info: 'Inside range',
            },];

        var modelIndex = 0; // Red - outside of range
        var setModel = function (model, entity) 
        {
            if (model.scale) 
            {
                entity.setAttribute('scale', model.scale);
            }

            if (model.rotation) 
            {
                entity.setAttribute('rotation', model.rotation);
            }

            if (model.position) 
            {
                entity.setAttribute('position', model.position);
            }

            entity.setAttribute('gltf-model', model.url);

            const div = document.querySelector('.instructions');
            div.innerText = model.info;
        };

        function renderPlaces(places) 
        {
            let scene = document.querySelector('a-scene');

            places.forEach((place) => 
            {
                let latitude = place.location.lat;
                let longitude = place.location.lng;

                let model = document.createElement('a-entity');
                model.setAttribute('gps-entity-place', `latitude: 52.2667465209961; longitude: -7.09122848510742;`);

                setModel(models[modelIndex], model);

                scene.appendChild(model);
            });
        } // End of renderPlaces method

        function acquireDistance()
        {
            const div = document.querySelector('.instructions');
            const distanceMsg = document.querySelector('[gps-entity-place]').getAttribute('distanceMsg');
            var distance = document.querySelector('[gps-entity-place]').getAttribute('distance');
            div.innerText = distanceMsg;
            var entity = document.querySelector('[gps-entity-place]');

            if(distance > 5)
            {
                setModel(models[0], entity);
            } // End of if we are outside range
  
            else
            {
                setModel(models[1], entity);  // Green model
            } // End of we are within the 5 metre range
          
        } // End of acquireDistance function
    </script>
    <link rel="stylesheet" type="text/css" href="./style.css"/>
</head>
    
<body style='margin: 0; overflow: hidden;'>
    <div class="centered instructions"></div>
    <a-scene 
        vr-mode-ui='enabled: false' 
        embedded
        arjs='sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;'>
    <a-camera
              look-controls-enabled="false"
              arjs-look-controls="smoothingFactor: 0.4"
              gps-camera="gpsMinDistance: 5" 
              rotation-reader>
    </a-camera>
</a-scene>
<div class="centered">
    <button data-action="change"></button>
</div>
</body>
